<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Reset Flow Test - UniLingo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #1976d2;
        }
        .critical { border-left-color: #d32f2f; }
        .success { border-left-color: #388e3c; }
        .warning { border-left-color: #f57c00; }
        .test-btn {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-btn:hover { background: #1565c0; }
        .test-btn:disabled { background: #ccc; cursor: not-allowed; }
        .result {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 3px solid #388e3c;
        }
        .error {
            background: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 3px solid #d32f2f;
        }
        .info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 3px solid #1976d2;
        }
        .code {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        .url-test {
            background: #fff3e0;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 3px solid #f57c00;
        }
    </style>
</head>
<body>
    <h1>🔬 Password Reset Flow Comprehensive Test</h1>
    
    <div class="test-section critical">
        <h2>🎯 COMPREHENSIVE VALIDATION</h2>
        <p>This test validates every aspect of the password reset flow to ensure it works correctly.</p>
    </div>

    <div class="test-section">
        <h2>1. Configuration Validation</h2>
        <button class="test-btn" onclick="testConfiguration()">Test Configuration</button>
        <div id="config-results"></div>
    </div>

    <div class="test-section">
        <h2>2. URL Parameter Parsing Test</h2>
        <button class="test-btn" onclick="testUrlParsing()">Test URL Parsing</button>
        <div id="url-results"></div>
    </div>

    <div class="test-section">
        <h2>3. Token Validation Test</h2>
        <button class="test-btn" onclick="testTokenValidation()">Test Token Validation</button>
        <div id="token-results"></div>
    </div>

    <div class="test-section">
        <h2>4. Supabase Auth Test</h2>
        <button class="test-btn" onclick="testSupabaseAuth()">Test Supabase Auth</button>
        <div id="auth-results"></div>
    </div>

    <div class="test-section">
        <h2>5. Password Reset Flow Simulation</h2>
        <button class="test-btn" onclick="simulatePasswordReset()">Simulate Password Reset</button>
        <div id="flow-results"></div>
    </div>

    <div class="test-section">
        <h2>6. Error Handling Test</h2>
        <button class="test-btn" onclick="testErrorHandling()">Test Error Handling</button>
        <div id="error-results"></div>
    </div>

    <div class="test-section">
        <h2>7. Real URL Test Scenarios</h2>
        <button class="test-btn" onclick="testRealUrls()">Test Real URL Scenarios</button>
        <div id="real-url-results"></div>
    </div>

    <div class="test-section success">
        <h2>✅ Final Validation</h2>
        <button class="test-btn" onclick="runFinalValidation()">Run Final Validation</button>
        <div id="final-results"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script>
        const supabase = window.supabase.createClient(
            window.UNILINGO_CONFIG.supabase.url,
            window.UNILINGO_CONFIG.supabase.anonKey
        );

        function logResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            container.appendChild(div);
        }

        function testConfiguration() {
            logResult('config-results', 'Testing configuration...', 'info');
            
            try {
                // Test 1: Config loaded
                if (!window.UNILINGO_CONFIG) {
                    logResult('config-results', '❌ UNILINGO_CONFIG not loaded', 'error');
                    return;
                }
                logResult('config-results', '✅ UNILINGO_CONFIG loaded', 'success');
                
                // Test 2: Supabase URL
                if (!window.UNILINGO_CONFIG.supabase.url) {
                    logResult('config-results', '❌ Supabase URL missing', 'error');
                    return;
                }
                logResult('config-results', `✅ Supabase URL: ${window.UNILINGO_CONFIG.supabase.url}`, 'success');
                
                // Test 3: Supabase Key
                if (!window.UNILINGO_CONFIG.supabase.anonKey) {
                    logResult('config-results', '❌ Supabase key missing', 'error');
                    return;
                }
                logResult('config-results', `✅ Supabase key: ${window.UNILINGO_CONFIG.supabase.anonKey.substring(0, 20)}...`, 'success');
                
                // Test 4: Supabase client creation
                const testClient = window.supabase.createClient(
                    window.UNILINGO_CONFIG.supabase.url,
                    window.UNILINGO_CONFIG.supabase.anonKey
                );
                if (!testClient) {
                    logResult('config-results', '❌ Failed to create Supabase client', 'error');
                    return;
                }
                logResult('config-results', '✅ Supabase client created successfully', 'success');
                
                logResult('config-results', '🎉 Configuration test passed!', 'success');
                
            } catch (error) {
                logResult('config-results', `❌ Configuration test failed: ${error.message}`, 'error');
            }
        }

        function testUrlParsing() {
            logResult('url-results', 'Testing URL parameter parsing...', 'info');
            
            // Test URLs that should work
            const testUrls = [
                {
                    name: 'Valid token URL',
                    url: 'https://unilingo.co.uk/fixed-reset-password.html#access_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c&refresh_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c&type=recovery',
                    expectedTokens: ['access_token', 'refresh_token', 'type']
                },
                {
                    name: 'Error URL (should be handled)',
                    url: 'https://unilingo.co.uk/fixed-reset-password.html#error=access_denied&error_code=otp_expired&error_description=Email+link+is+invalid+or+has+expired',
                    expectedTokens: ['error', 'error_code', 'error_description']
                },
                {
                    name: 'Recovery token URL',
                    url: 'https://unilingo.co.uk/fixed-reset-password.html?token=abc123&type=recovery',
                    expectedTokens: ['token', 'type']
                }
            ];
            
            testUrls.forEach(test => {
                logResult('url-results', `Testing: ${test.name}`, 'info');
                
                // Simulate URL parsing
                const url = new URL(test.url);
                const params = {};
                
                // Parse hash
                if (url.hash) {
                    const hashString = url.hash.substring(1);
                    try {
                        const hashParams = new URLSearchParams(hashString);
                        for (const [key, value] of hashParams.entries()) {
                            params[key] = value;
                        }
                    } catch (e) {
                        // Manual parsing fallback
                        const pairs = hashString.split('&');
                        pairs.forEach(pair => {
                            const [key, value] = pair.split('=');
                            if (key && value) {
                                params[key] = decodeURIComponent(value);
                            }
                        });
                    }
                }
                
                // Parse query
                if (url.search) {
                    const urlParams = new URLSearchParams(url.search);
                    for (const [key, value] of urlParams.entries()) {
                        params[key] = value;
                    }
                }
                
                // Validate expected tokens
                const foundTokens = test.expectedTokens.filter(token => params[token]);
                if (foundTokens.length === test.expectedTokens.length) {
                    logResult('url-results', `✅ ${test.name}: All expected tokens found`, 'success');
                } else {
                    logResult('url-results', `❌ ${test.name}: Missing tokens. Found: ${foundTokens.join(', ')}`, 'error');
                }
                
                logResult('url-results', `Parsed params: ${JSON.stringify(params, null, 2)}`, 'info');
            });
        }

        async function testTokenValidation() {
            logResult('token-results', 'Testing token validation...', 'info');
            
            try {
                // Test 1: Session check
                const { data: { session }, error } = await supabase.auth.getSession();
                if (error) {
                    logResult('token-results', `Session check error: ${error.message}`, 'info');
                } else {
                    logResult('token-results', `Session status: ${session ? 'Active' : 'None'}`, 'info');
                }
                
                // Test 2: Auth state
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                if (userError) {
                    logResult('token-results', `User check error: ${userError.message}`, 'info');
                } else {
                    logResult('token-results', `User status: ${user ? 'Authenticated' : 'Not authenticated'}`, 'info');
                }
                
                logResult('token-results', '✅ Token validation test completed', 'success');
                
            } catch (error) {
                logResult('token-results', `❌ Token validation test failed: ${error.message}`, 'error');
            }
        }

        async function testSupabaseAuth() {
            logResult('auth-results', 'Testing Supabase Auth...', 'info');
            
            try {
                // Test 1: Auth settings
                const response = await fetch(`${window.UNILINGO_CONFIG.supabase.url}/auth/v1/settings`, {
                    headers: {
                        'apikey': window.UNILINGO_CONFIG.supabase.anonKey
                    }
                });
                
                if (response.ok) {
                    const settings = await response.json();
                    logResult('auth-results', '✅ Auth settings accessible', 'success');
                    logResult('auth-results', `Email auth enabled: ${settings.external?.email || 'Unknown'}`, 'info');
                } else {
                    logResult('auth-results', `❌ Auth settings error: ${response.status}`, 'error');
                }
                
                // Test 2: Password reset endpoint
                const resetResponse = await fetch(`${window.UNILINGO_CONFIG.supabase.url}/auth/v1/recover`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': window.UNILINGO_CONFIG.supabase.anonKey
                    },
                    body: JSON.stringify({
                        email: 'test@example.com',
                        redirectTo: 'https://unilingo.co.uk/fixed-reset-password.html'
                    })
                });
                
                if (resetResponse.ok) {
                    logResult('auth-results', '✅ Password reset endpoint accessible', 'success');
                } else {
                    const errorData = await resetResponse.json();
                    logResult('auth-results', `Password reset endpoint response: ${resetResponse.status} - ${JSON.stringify(errorData)}`, 'info');
                }
                
            } catch (error) {
                logResult('auth-results', `❌ Supabase Auth test failed: ${error.message}`, 'error');
            }
        }

        async function simulatePasswordReset() {
            logResult('flow-results', 'Simulating password reset flow...', 'info');
            
            try {
                // Step 1: Request password reset
                logResult('flow-results', 'Step 1: Requesting password reset...', 'info');
                const { error } = await supabase.auth.resetPasswordForEmail('harry.emes@worc.ox.ac.uk', {
                    redirectTo: 'https://unilingo.co.uk/fixed-reset-password.html'
                });
                
                if (error) {
                    logResult('flow-results', `❌ Password reset request failed: ${error.message}`, 'error');
                    return;
                }
                
                logResult('flow-results', '✅ Password reset request sent successfully', 'success');
                logResult('flow-results', '📧 Check your email for the reset link', 'info');
                logResult('flow-results', '🔗 Click the link and test the fixed-reset-password.html page', 'info');
                
            } catch (error) {
                logResult('flow-results', `❌ Password reset simulation failed: ${error.message}`, 'error');
            }
        }

        function testErrorHandling() {
            logResult('error-results', 'Testing error handling...', 'info');
            
            // Test various error scenarios
            const errorScenarios = [
                {
                    name: 'Missing tokens',
                    url: 'https://unilingo.co.uk/fixed-reset-password.html',
                    shouldFail: true
                },
                {
                    name: 'Invalid token format',
                    url: 'https://unilingo.co.uk/fixed-reset-password.html#access_token=invalid&refresh_token=invalid',
                    shouldFail: true
                },
                {
                    name: 'Error in URL',
                    url: 'https://unilingo.co.uk/fixed-reset-password.html#error=access_denied&error_code=otp_expired',
                    shouldFail: true
                }
            ];
            
            errorScenarios.forEach(scenario => {
                logResult('error-results', `Testing: ${scenario.name}`, 'info');
                
                // Simulate URL parsing
                const url = new URL(scenario.url);
                const params = {};
                
                if (url.hash) {
                    const hashString = url.hash.substring(1);
                    try {
                        const hashParams = new URLSearchParams(hashString);
                        for (const [key, value] of hashParams.entries()) {
                            params[key] = value;
                        }
                    } catch (e) {
                        const pairs = hashString.split('&');
                        pairs.forEach(pair => {
                            const [key, value] = pair.split('=');
                            if (key && value) {
                                params[key] = decodeURIComponent(value);
                            }
                        });
                    }
                }
                
                // Check if error is properly detected
                if (params.error) {
                    logResult('error-results', `✅ Error detected: ${params.error}`, 'success');
                } else if (!params.access_token && !params.token) {
                    logResult('error-results', '✅ No tokens detected (should show error)', 'success');
                } else {
                    logResult('error-results', '✅ Tokens detected (should proceed)', 'success');
                }
            });
        }

        function testRealUrls() {
            logResult('real-url-results', 'Testing real URL scenarios...', 'info');
            
            // These are the actual URLs you've been getting
            const realUrls = [
                'https://unilingo.co.uk/reset-password.html#error=access_denied&error_code=otp_expired&error_description=Email+link+is+invalid+or+has+expired',
                'https://unilingo.co.uk/fixed-reset-password.html#access_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9&refresh_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9&type=recovery',
                'https://unilingo.co.uk/fixed-reset-password.html?token=abc123&type=recovery'
            ];
            
            realUrls.forEach((url, index) => {
                logResult('real-url-results', `Testing URL ${index + 1}: ${url}`, 'info');
                
                // Parse the URL
                const urlObj = new URL(url);
                const params = {};
                
                // Parse hash
                if (urlObj.hash) {
                    const hashString = urlObj.hash.substring(1);
                    try {
                        const hashParams = new URLSearchParams(hashString);
                        for (const [key, value] of hashParams.entries()) {
                            params[key] = value;
                        }
                    } catch (e) {
                        const pairs = hashString.split('&');
                        pairs.forEach(pair => {
                            const [key, value] = pair.split('=');
                            if (key && value) {
                                params[key] = decodeURIComponent(value);
                            }
                        });
                    }
                }
                
                // Parse query
                if (urlObj.search) {
                    const urlParams = new URLSearchParams(urlObj.search);
                    for (const [key, value] of urlParams.entries()) {
                        params[key] = value;
                    }
                }
                
                // Analyze the URL
                if (params.error) {
                    logResult('real-url-results', `❌ Error URL detected: ${params.error}`, 'error');
                    logResult('real-url-results', `Error code: ${params.error_code}`, 'info');
                    logResult('real-url-results', `Description: ${params.error_description}`, 'info');
                } else if (params.access_token && params.refresh_token) {
                    logResult('real-url-results', '✅ Valid token URL detected', 'success');
                    logResult('real-url-results', `Type: ${params.type}`, 'info');
                } else if (params.token && params.type === 'recovery') {
                    logResult('real-url-results', '✅ Valid recovery token URL detected', 'success');
                } else {
                    logResult('real-url-results', '⚠️ Unknown URL format', 'warning');
                }
                
                logResult('real-url-results', `Parsed parameters: ${JSON.stringify(params, null, 2)}`, 'info');
            });
        }

        async function runFinalValidation() {
            logResult('final-results', 'Running final validation...', 'info');
            
            let allTestsPassed = true;
            
            try {
                // Test 1: Configuration
                if (!window.UNILINGO_CONFIG) {
                    logResult('final-results', '❌ Configuration not loaded', 'error');
                    allTestsPassed = false;
                } else {
                    logResult('final-results', '✅ Configuration loaded', 'success');
                }
                
                // Test 2: Supabase connection
                const { data, error } = await supabase.auth.getSession();
                if (error) {
                    logResult('final-results', `Supabase connection: ${error.message}`, 'info');
                } else {
                    logResult('final-results', '✅ Supabase connection working', 'success');
                }
                
                // Test 3: URL parsing logic
                const testUrl = 'https://unilingo.co.uk/fixed-reset-password.html#access_token=test&refresh_token=test&type=recovery';
                const urlObj = new URL(testUrl);
                const params = {};
                
                if (urlObj.hash) {
                    const hashString = urlObj.hash.substring(1);
                    const hashParams = new URLSearchParams(hashString);
                    for (const [key, value] of hashParams.entries()) {
                        params[key] = value;
                    }
                }
                
                if (params.access_token && params.refresh_token) {
                    logResult('final-results', '✅ URL parsing logic working', 'success');
                } else {
                    logResult('final-results', '❌ URL parsing logic failed', 'error');
                    allTestsPassed = false;
                }
                
                // Final verdict
                if (allTestsPassed) {
                    logResult('final-results', '🎉 ALL TESTS PASSED! The fix should work.', 'success');
                    logResult('final-results', '✅ Ready for real-world testing', 'success');
                } else {
                    logResult('final-results', '❌ Some tests failed. Review the issues above.', 'error');
                }
                
            } catch (error) {
                logResult('final-results', `❌ Final validation failed: ${error.message}`, 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            logResult('config-results', 'Password reset flow test loaded', 'success');
        });
    </script>
</body>
</html>
