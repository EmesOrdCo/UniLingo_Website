<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password Test - UniLingo</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
</head>
<body>
    <h1>Reset Password Test Page</h1>
    <div id="results"></div>
    
    <script>
        const results = document.getElementById('results');
        
        function log(message) {
            console.log(message);
            results.innerHTML += `<p>${message}</p>`;
        }
        
        async function runTests() {
            log('=== STARTING RESET PASSWORD TESTS ===');
            
            // Test 1: Config Loading
            log('Test 1: Checking config.js...');
            if (window.UNILINGO_CONFIG) {
                log('✅ Config loaded successfully');
                log(`   - Supabase URL: ${window.UNILINGO_CONFIG.supabase.url}`);
                log(`   - Has anon key: ${!!window.UNILINGO_CONFIG.supabase.anonKey}`);
            } else {
                log('❌ Config not loaded');
                return;
            }
            
            // Test 2: Supabase Library
            log('Test 2: Checking Supabase library...');
            if (window.supabase) {
                log('✅ Supabase library loaded');
            } else {
                log('❌ Supabase library not loaded');
                return;
            }
            
            // Test 3: Supabase Client Initialization
            log('Test 3: Initializing Supabase client...');
            try {
                const supabase = window.supabase.createClient(
                    window.UNILINGO_CONFIG.supabase.url,
                    window.UNILINGO_CONFIG.supabase.anonKey
                );
                log('✅ Supabase client created');
                
                // Test 4: Connection Test
                log('Test 4: Testing Supabase connection...');
                const { data: { session }, error } = await supabase.auth.getSession();
                if (error) {
                    log(`❌ Connection error: ${error.message}`);
                } else {
                    log('✅ Supabase connection successful');
                }
                
                // Test 5: URL Parameter Parsing
                log('Test 5: Testing URL parameter parsing...');
                const testUrls = [
                    'https://unilingo.co.uk/reset-password.html?token=abc123&type=recovery',
                    'https://unilingo.co.uk/reset-password.html#token=abc123&type=recovery',
                    'https://unilingo.co.uk/reset-password.html?access_token=abc123&refresh_token=def456',
                    'https://unilingo.co.uk/reset-password.html#error=access_denied&error_code=otp_expired'
                ];
                
                testUrls.forEach((url, index) => {
                    log(`   Test URL ${index + 1}: ${url}`);
                    const urlObj = new URL(url);
                    const urlParams = new URLSearchParams(urlObj.search);
                    const hashParams = new URLSearchParams(urlObj.hash.substring(1));
                    
                    const token = urlParams.get('token') || hashParams.get('token');
                    const type = urlParams.get('type') || hashParams.get('type');
                    const access_token = urlParams.get('access_token') || hashParams.get('access_token');
                    const refresh_token = urlParams.get('refresh_token') || hashParams.get('refresh_token');
                    const error = urlParams.get('error') || hashParams.get('error');
                    
                    log(`      - Token: ${!!token}`);
                    log(`      - Type: ${type}`);
                    log(`      - Access Token: ${!!access_token}`);
                    log(`      - Refresh Token: ${!!refresh_token}`);
                    log(`      - Error: ${error || 'none'}`);
                });
                
                // Test 6: Email Template Configuration
                log('Test 6: Checking email template configuration...');
                log('   - Site URL should be: https://unilingo.co.uk');
                log('   - Redirect URL should be: https://unilingo.co.uk/reset-password.html');
                log('   - Email template should use: {{ .ConfirmationURL }}');
                
                // Test 7: Password Validation
                log('Test 7: Testing password validation...');
                const testPasswords = ['1234567', 'password123', 'Password123!'];
                testPasswords.forEach(pwd => {
                    const isValid = pwd.length >= 8;
                    log(`   - "${pwd}": ${isValid ? 'Valid' : 'Invalid'} (length: ${pwd.length})`);
                });
                
                log('=== ALL TESTS COMPLETED ===');
                
            } catch (error) {
                log(`❌ Supabase client creation failed: ${error.message}`);
            }
        }
        
        // Run tests when page loads
        document.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html>
